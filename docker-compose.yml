services:
  postgres:
    image: postgres:16-alpine
    container_name: picoclaw-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-picoclaw}
      POSTGRES_USER: ${POSTGRES_USER:-picoclaw}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-picoclaw}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-picoclaw} -d ${POSTGRES_DB:-picoclaw}"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  picoclaw-gateway:
    image: golang:1.24-bookworm
    container_name: picoclaw-gateway
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${PICOCLAW_GATEWAY_PORT:-18790}:18790"
      - "${PICOCLAW_DASHBOARD_PORT:-18791}:18791"
    working_dir: /opt
    volumes:
      - picoclaw_data:/root/.picoclaw
      - picoclaw_src:/opt/picoclaw
    environment:
      TZ: ${TZ:-UTC}
      REPO_URL: ${REPO_URL:-https://github.com/caam1406/picoclaw.git}
      REPO_BRANCH: ${REPO_BRANCH:-main}
      DASHBOARD_TOKEN: ${DASHBOARD_TOKEN:-CHANGE_ME_DASHBOARD_TOKEN}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      POSTGRES_DB: ${POSTGRES_DB:-picoclaw}
      POSTGRES_USER: ${POSTGRES_USER:-picoclaw}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-picoclaw}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:18791/ >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 40s
    command:
      - /bin/bash
      - -lc
      - |
        set -euo pipefail
        echo "[picoclaw-gateway] initializing..."
        echo "[picoclaw-gateway] repo=$${REPO_URL} branch=$${REPO_BRANCH}"

        if [ ! -d /opt/picoclaw/.git ]; then
          echo "[picoclaw-gateway] cloning repository..."
          git clone --branch "$${REPO_BRANCH}" "$${REPO_URL}" /opt/picoclaw
        else
          echo "[picoclaw-gateway] updating repository..."
          git -C /opt/picoclaw fetch --all --tags
          git -C /opt/picoclaw checkout "$${REPO_BRANCH}"
          git -C /opt/picoclaw pull --ff-only origin "$${REPO_BRANCH}"
        fi

        cd /opt/picoclaw
        GO_BIN="$(command -v go || true)"
        if [ -z "$${GO_BIN}" ] && [ -x /usr/local/go/bin/go ]; then
          GO_BIN="/usr/local/go/bin/go"
        fi
        if [ -z "$${GO_BIN}" ]; then
          echo "[picoclaw-gateway] ERROR: Go binary not found. Current PATH=$${PATH}"
          ls -la /usr/local/go/bin || true
          exit 1
        fi
        echo "[picoclaw-gateway] using go binary: $${GO_BIN}"
        echo "[picoclaw-gateway] downloading go modules..."
        "$${GO_BIN}" mod download
        echo "[picoclaw-gateway] building binary..."
        "$${GO_BIN}" build -o /usr/local/bin/picoclaw ./cmd/picoclaw

        if [ ! -f /root/.picoclaw/picoclaw.db ]; then
          echo "[picoclaw-gateway] first boot: writing bootstrap config..."
          mkdir -p /root/.picoclaw
          cat > /root/.picoclaw/config.json <<EOF
        {
          "agents": {
            "default_profile": "default",
            "defaults": {
              "workspace": "~/.picoclaw/workspace",
              "model": "glm-4.5",
              "max_tokens": 8192,
              "temperature": 0.1,
              "max_tool_iterations": 20
            },
            "profiles": {}
          },
          "providers": {
            "openrouter": {
              "api_key": "$${OPENROUTER_API_KEY}",
              "api_base": "https://openrouter.ai/api/v1"
            },
            "anthropic": {"api_key": "", "api_base": ""},
            "openai": {"api_key": "", "api_base": ""},
            "groq": {"api_key": "", "api_base": ""},
            "zhipu": {"api_key": "", "api_base": ""},
            "zai": {"api_key": "", "api_base": ""},
            "gemini": {"api_key": "", "api_base": ""},
            "vllm": {"api_key": "", "api_base": ""}
          },
          "channels": {
            "whatsapp": {"enabled": false, "store_path": "~/.picoclaw/whatsapp.db", "allow_from": []},
            "telegram": {"enabled": false, "token": "", "allow_from": []},
            "discord": {"enabled": false, "token": "", "allow_from": []},
            "feishu": {"enabled": false, "app_id": "", "app_secret": "", "encrypt_key": "", "verification_token": "", "allow_from": []},
            "qq": {"enabled": false, "app_id": "", "app_secret": "", "allow_from": []},
            "dingtalk": {"enabled": false, "client_id": "", "client_secret": "", "allow_from": []},
            "maixcam": {"enabled": false, "host": "0.0.0.0", "port": 18790, "allow_from": []}
          },
          "tools": {"web": {"search": {"api_key": "", "max_results": 5}}},
          "gateway": {"host": "0.0.0.0", "port": 18790},
          "dashboard": {
            "enabled": true,
            "host": "0.0.0.0",
            "port": 18791,
            "token": "$${DASHBOARD_TOKEN}",
            "contacts_only": false
          },
          "storage": {
            "type": "postgres",
            "database_url": "postgres://$${POSTGRES_USER}:$${POSTGRES_PASSWORD}@postgres:5432/$${POSTGRES_DB}?sslmode=disable",
            "file_path": "~/.picoclaw/workspace/sessions",
            "ssl_enabled": false
          }
        }
        EOF
        fi

        echo "[picoclaw-gateway] starting gateway and dashboard..."
        exec /usr/local/bin/picoclaw gateway --debug
    restart: unless-stopped

volumes:
  postgres_data:
  picoclaw_data:
  picoclaw_src:
