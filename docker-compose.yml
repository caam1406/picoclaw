version: "3.9"

services:
  init-secrets:
    image: alpine:3.20
    container_name: picoclaw-init-secrets
    environment:
      DASHBOARD_TOKEN: ${DASHBOARD_TOKEN:-}
    volumes:
      - picoclaw_secrets:/run/picoclaw-secrets
    command:
      - /bin/sh
      - -lc
      - |
        set -eu
        umask 077
        mkdir -p /run/picoclaw-secrets

        if [ ! -s /run/picoclaw-secrets/dashboard_token ]; then
          if [ -n "${DASHBOARD_TOKEN:-}" ]; then
            printf "%s" "${DASHBOARD_TOKEN}" > /run/picoclaw-secrets/dashboard_token
          else
            head -c 48 /dev/urandom | base64 | tr -d '\n' > /run/picoclaw-secrets/dashboard_token
          fi
        fi

        chmod 600 /run/picoclaw-secrets/dashboard_token
    restart: "no"

  picoclaw-gateway:
    image: debian:bookworm-slim
    container_name: picoclaw-gateway

    depends_on:
      init-secrets:
        condition: service_completed_successfully

    ports:
      - "${PICOCLAW_GATEWAY_PORT:-18790}:18790"
      - "${PICOCLAW_DASHBOARD_PORT:-18791}:18791"

    working_dir: /opt

    volumes:
      - picoclaw_data:/root/.picoclaw
      - picoclaw_src:/opt/picoclaw
      - picoclaw_secrets:/run/picoclaw-secrets:ro

    environment:
      TZ: ${TZ:-UTC}
      REPO_URL: ${REPO_URL:-https://github.com/caam1406/picoclaw.git}
      REPO_BRANCH: ${REPO_BRANCH:-main}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      PICOCLAW_PROVIDERS_OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      GOOGLE_OAUTH_CLIENT_ID: ${GOOGLE_OAUTH_CLIENT_ID:-}
      GOOGLE_OAUTH_CLIENT_SECRET: ${GOOGLE_OAUTH_CLIENT_SECRET:-}
      OAUTHLIB_INSECURE_TRANSPORT: ${OAUTHLIB_INSECURE_TRANSPORT:-1}
      GOG_ACCOUNT: ${GOG_ACCOUNT:-}
      PICOCLAW_TOOLS_GOGCLI_ENABLED: ${PICOCLAW_TOOLS_GOGCLI_ENABLED:-false}
      PICOCLAW_STORAGE_TYPE: ${PICOCLAW_STORAGE_TYPE:-file}
      PICOCLAW_STORAGE_FILE_PATH: ${PICOCLAW_STORAGE_FILE_PATH:-~/.picoclaw/workspace/sessions}
      PICOCLAW_DASHBOARD_TOKEN: ${PICOCLAW_DASHBOARD_TOKEN:-}
      PICOCLAW_DASHBOARD_HOST: "0.0.0.0"

    healthcheck:
      test: [ "CMD-SHELL", "curl -fsS http://127.0.0.1:18791/ >/dev/null || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 40s

    command:
      - /bin/bash
      - -lc
      - |
        set -euo pipefail
        echo "[picoclaw-gateway] initializing..."
        echo "[picoclaw-gateway] repo=$${REPO_URL} branch=$${REPO_BRANCH}"

        SECRETS_DIR=/run/picoclaw-secrets
        if [ -s "$${SECRETS_DIR}/dashboard_token" ] && [ -z "$${PICOCLAW_DASHBOARD_TOKEN:-}" ]; then
          export PICOCLAW_DASHBOARD_TOKEN="$$(cat "$${SECRETS_DIR}/dashboard_token")"
        fi

        # Install minimal dependencies (only on first run, cached in volume)
        if ! command -v git >/dev/null 2>&1; then
          echo "[picoclaw-gateway] installing dependencies..."
          apt-get update
          apt-get install -y --no-install-recommends curl ca-certificates git
          rm -rf /var/lib/apt/lists/*
        fi

        if [ ! -d /opt/picoclaw/.git ]; then
          echo "[picoclaw-gateway] cloning repository..."
          git clone --branch "$${REPO_BRANCH}" "$${REPO_URL}" /opt/picoclaw
        else
          echo "[picoclaw-gateway] updating repository..."
          git -C /opt/picoclaw fetch --all --tags
          git -C /opt/picoclaw checkout "$${REPO_BRANCH}"
          git -C /opt/picoclaw pull --ff-only origin "$${REPO_BRANCH}"
        fi

        cd /opt/picoclaw

        # Detect architecture and copy pre-built binary
        ARCH="$$(dpkg --print-architecture 2>/dev/null || uname -m)"
        case "$${ARCH}" in
          amd64|x86_64) ARCH="amd64" ;;
          arm64|aarch64) ARCH="arm64" ;;
        esac

        BINARY="build/picoclaw-linux-$${ARCH}"
        if [ ! -f "$${BINARY}" ]; then
          echo "[picoclaw-gateway] ERROR: pre-built binary not found: $${BINARY}"
          echo "[picoclaw-gateway] Run scripts/build.sh or scripts/build.ps1 to compile"
          exit 1
        fi

        echo "[picoclaw-gateway] installing binary: $${BINARY}"
        cp "$${BINARY}" /usr/local/bin/picoclaw
        chmod +x /usr/local/bin/picoclaw

        export PATH="$${HOME}/.local/bin:$${PATH}"

        # Install uv runtime if not present
        if ! command -v uvx >/dev/null 2>&1; then
          echo "[picoclaw-gateway] installing uv runtime..."
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$${HOME}/.local/bin:$${PATH}"
        fi

        # Configure gogcli if enabled and binary is available
        if [ "$${PICOCLAW_TOOLS_GOGCLI_ENABLED:-false}" = "true" ] || [ "$${PICOCLAW_TOOLS_GOGCLI_ENABLED:-0}" = "1" ]; then
          GOG_BIN="$$(command -v gog || command -v gogcli || true)"

          if [ -n "$${GOG_BIN}" ] && \
             [ -n "$${GOOGLE_OAUTH_CLIENT_ID:-}" ] && \
             [ -n "$${GOOGLE_OAUTH_CLIENT_SECRET:-}" ]; then

            echo "[picoclaw-gateway] configuring gog OAuth..."

            mkdir -p /root/.config/gog

            printf '%s\n' \
              '{"installed":{"client_id":"'"$${GOOGLE_OAUTH_CLIENT_ID}"'","project_id":"picoclaw-gog","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_secret":"'"$${GOOGLE_OAUTH_CLIENT_SECRET}"'","redirect_uris":["http://127.0.0.1","http://localhost"]}}' \
              > /root/.config/gog/oauth_client.json

            "$${GOG_BIN}" auth credentials /root/.config/gog/oauth_client.json || true
          fi
        fi

        echo "[picoclaw-gateway] starting gateway..."
        exec /usr/local/bin/picoclaw gateway --debug

    restart: unless-stopped

volumes:
  picoclaw_data:
  picoclaw_src:
  picoclaw_secrets:
